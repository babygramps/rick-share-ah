# Couple can be:
# - Created by owner (partner1)
# - Read/Updated by any authenticated user (needed for partner2 to join via invite code)
# Note: Invite code verification in app logic provides security for join
type Couple @model @auth(rules: [
  { allow: owner },
  { allow: private, operations: [read, update] }
]) {
  id: ID!
  name: String!
  partner1Id: String!
  partner1Name: String!
  partner1Email: String!
  partner2Id: String
  partner2Name: String
  partner2Email: String
  inviteCode: String @index(name: "byInviteCode")
  defaultSplitPercent: Int!
  expenses: [Expense] @hasMany
  settlements: [Settlement] @hasMany
}

# Expenses: owner can do everything, but we need both partners to access
# Using private for now - both authenticated partners can read/write
type Expense @model @auth(rules: [
  { allow: owner },
  { allow: private, operations: [read, create, update, delete] }
]) {
  id: ID!
  coupleId: ID! @index(name: "byCouple")
  couple: Couple @belongsTo(fields: ["coupleId"])
  description: String!
  amount: Int!
  paidBy: String!
  splitType: String!
  partner1Share: Int!
  partner2Share: Int!
  category: String!
  date: AWSDate!
  note: String
}

# Settlements: same auth as expenses
type Settlement @model @auth(rules: [
  { allow: owner },
  { allow: private, operations: [read, create, update, delete] }
]) {
  id: ID!
  coupleId: ID! @index(name: "byCouple")
  couple: Couple @belongsTo(fields: ["coupleId"])
  amount: Int!
  paidBy: String!
  paidTo: String!
  date: AWSDate!
  note: String
}

# Receipt scanning result returned by Textract processing
type LineItem @aws_cognito_user_pools {
  description: String
  price: Int
  quantity: Int
}

type ReceiptScan @aws_cognito_user_pools {
  id: ID!
  status: String!
  merchantName: String
  totalAmount: Int
  date: AWSDate
  category: String
  confidence: Float
  lineItems: [LineItem]
  rawText: String
  imageUrl: String
}

type Mutation {
  processReceipt(imageKey: String!): ReceiptScan 
    @function(name: "processReceipt-${env}")
    @auth(rules: [{ allow: private }])
}
